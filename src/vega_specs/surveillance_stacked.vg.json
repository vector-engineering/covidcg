{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Stacked bar chart for different regions of the world.",
  "width": 1000,
  "height": 350,
  "padding": 5,
  "signals": [
    {
      "name": "other_hover",
      "value": null
    },
    {
      "name": "hoverGroup",
      "value": null,
      "on": [
        {
          "events": "rect:mouseover!",
          "update": "datum.group"
        },
        {
          "events": "rect:mouseout!",
          "update": "null"
        }
      ]
    },
    { "name": "mode", "value": "lineage" },
    { "name": "sortField", "value": "group" },
    { "name": "sortDirection", "value": "ascending" },
    { "name": "display_min_counts", "value": 5 },
    { "name": "display_min_percent", "value": 0.01 },
    { "name": "sig_min_counts", "value": 10 },
    { "name": "sig_min_percent", "value": 0.05 },
    { "name": "sig_min_r", "value": 0.5 },

    { "name": "facet_width", "update": "width" },
    { "name": "facet_x", "update": "0" },

    { "name": "subplot_hpadding", "value": 90 },
    {
      "name": "subplot_width",
      "update": "(facet_width - (subplot_hpadding * 2.4)) / 3"
    },
    { "name": "subplot_range_x", "update": "[15, subplot_width - 15]" },
    { "name": "subplot_vpadding", "value": 100 },
    { "name": "subplot_height", "update": "(height - subplot_vpadding) / 2" },
    { "name": "subplot_range_y", "update": "[subplot_height, 0]" },
    {
      "name": "x_adjusted",
      "on": [
        {
          "events": "mousemove",
          "update": "x() - facet_x"
        }
      ]
    }
  ],

  "data": [
    
    {
      "name": "group_reg",
      "url": "https://storage.googleapis.com/ve-public/surveillance/group_regression2.csv",
      "format": {
        "type": "csv",
        "parse": {
          "slope": "number",
          "r": "number",
          "pval": "number",
          "counts": "number",
          "max_percent": "number"
        }
      },
      "transform": [
        {
          "type": "filter",
          "expr": "datum.type === mode"
        }
      ]
    },
    {
      "name": "hide_groups",
      "source": "group_reg",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["group"],
          "fields": ["counts", "max_percent"],
          "ops": ["sum", "max"],
          "as": ["counts", "max_percent"]
        },
        {
          "type": "filter",
          "expr": "datum.counts < display_min_counts || datum.max_percent < display_min_percent"
        },
        {
          "type": "formula",
          "as": "hide",
          "expr": "true"
        }
      ]
    },
    {
      "name": "valid_groups",
      "source": "group_reg",
      "transform": [
        {
          "type": "filter",
          "expr": "datum.r > sig_min_r && datum.counts > sig_min_counts && datum.max_percent > sig_min_percent"
        },
        {
          "type": "aggregate",
          "groupby": ["group"],
          "fields": ["counts", "max_percent"],
          "ops": ["sum", "max"],
          "as": ["counts", "max_percent"]
        }
      ]
    },
    {
      "name": "valid_groups_color",
      "source": "valid_groups",
      "transform": [
        {
          "type": "collect",
          "sort": {
            "field": { "signal": "sortField" },
            "order": { "signal": "sortDirection" }
          }
        },
        {
          "type": "formula",
          "expr": "scale('group_color', datum.group)",
          "as": "color"
        }
      ]
    },
    {
      "name": "group_counts",
      "url": "https://storage.googleapis.com/ve-public/surveillance/group_counts2.csv",
      "format": {
        "type": "csv",
        "parse": {
          "collection_week": "date",
          "counts": "number",
          "location_counts": "number",
          "percent": "number"
        }
      },
      "transform": [
        {
          "type": "filter",
          "expr": "datum.type === mode"
        },
        {
          "type": "lookup",
          "from": "hide_groups",
          "key": "group",
          "values": ["hide"],
          "fields": ["group"],
          "as": ["hide"],
          "default": false
        },
        {
          "type": "filter",
          "expr": "!datum.hide"
        },
        {
          "type": "filter",
          "expr": "if(indata('valid_groups', 'group', datum.group), true, false)"
        },
        {
          "type": "collect",
          "sort": {
            "field": ["region", "group", "collection_week"],
            "order": ["ascending", "ascending", "ascending"]
          }
        },
        {
                      "type": "stack",
                      "groupby": ["collection_week", "region"],
                      "sort": {"field": "group"},
                      "field": "percent"
                    }
      ]
    },
    {
      "name": "max_percents",
      "source": "group_counts",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["region"],
          "fields": ["percent"],
          "ops": ["max"],
          "as": ["percent"]
        },
        {
          "type": "identifier",
          "as": "index"
        }
      ]
    },
    {
      "name": "annotation",
      "values": [{ "start": -30, "end": 0 }],
      "transform": [
        {
          "type": "formula",
          "expr": "now() + (1000 * 60 * 60 * 24 * datum.start)",
          "as": "start"
        },
        {
          "type": "formula",
          "expr": "now() + (1000 * 60 * 60 * 24 * datum.end)",
          "as": "end"
        }
      ]
    },
    {
      "name": "hover_legend",
      "values": []
    }
  ],

  "scales": [
    {
      "name": "dateX",
      "type": "time",
      "domain": { "data": "group_counts", "field": "collection_week" },
      "range": { "signal": "subplot_range_x" }
    },
    {
      "name": "group_color",
      "type": "ordinal",
      "domain": { "data": "valid_groups", "field": "group" },
      "range": { "scheme": "tableau20" }
    }
  ],

  "marks": [
    {
      "name": "facets",
      "type": "group",
      "encode": {
        "update": {
          "x": { "signal": "facet_x" },
          "y": { "value": 0 },
          "width": { "signal": "facet_width" },
          "height": { "signal": "height" }
        }
      },
      "signals": [
        { "name": "width", "update": "facet_width" },
        { "name": "height", "update": "height" }
      ],

      "layout": {
        "columns": 3,
        "padding": {
          "row": { "signal": "subplot_vpadding" },
          "column": { "signal": "subplot_hpadding" }
        },
        "bounds": "flush"
      },

      "marks": [
        {
          "name": "region_grid",
          "type": "group",
          "encode": {
            "update": {
              "x": { "value": 0 },
              "width": { "signal": "subplot_width" },
              "height": { "signal": "subplot_height" }
            }
          },
          "signals": [
            { "name": "width", "update": "subplot_width" },
            { "name": "height", "update": "subplot_height" }
          ],
          "from": {
            "facet": {
              "name": "group_per_region",
              "data": "group_counts",
              "groupby": "region"
            }
            
          },

          "title": {
            "text": { "signal": "parent.region" },
            "anchor": "start",
            "frame": "group"
          },

          "scales": [
            {
              "name": "percentY",
              "type": "linear",
              "domain": { "data": "group_per_region", "field": "y1" },
              "domainMin": 0,
              "domainMax": 1,
              "range": { "signal": "subplot_range_y" }
            }
          ],
          "axes": [
            {
              "scale": "dateX",
              "orient": "bottom",
              "format": "%m-%d",
              "tickCount": "week",
              "grid": false,
              "gridColor": "#DDD",
              "labelAngle": 310,
              "labelAlign": "right",
              "labelBaseline": "middle",
              "labelPadding": 5,
              "labelFontSize": 12,
              "title": "Collection Date"
            },
            {
              "scale": "percentY",
              "orient": "left",
              "format": "%",
              "title": "Percent Sequences",
              "grid": true,
              "gridColor": "#EEE"
            }
          ],
          "marks": [
            {
              "type": "group",
              "from": {
                "facet": {
                  "name": "group_date",
                  "data": "group_per_region",
                  "groupby": "group"
                }
              },
              "signals": [],
              "data": [
                {
                  "name": "valid_group_date",
                  "source": "group_date",
                  "transform": [
                    {
                      "type": "filter",
                      "expr": "datum.valid || indata('valid_groups', 'group', datum.group)"
                    }
                  ]
                },
                {
                  "name": "invalid_group_date",
                  "source": "group_date",
                  "transform": [
                    {
                      "type": "filter",
                      "expr": "!datum.valid && !indata('valid_groups', 'group', datum.group)"
                    }
                  ]
                },
                {
                  "name": "max_date",
                  "source": "group_date",
                  "transform": [
                    {
                      "type": "aggregate",
                      "groupby": ["group"],
                      "fields": ["collection_week"],
                      "ops": ["max"],
                      "as": ["max_date"]
                    }
                  ]
                },
                {
                  "name": "label",
                  "source": "group_date",
                  "transform": [
                    {
                      "type": "filter",
                      "expr": "datum.collection_week == data('max_date')[0]['max_date']"
                    }
                  ]
                }
              ],
              "marks": [
                {
                  "type": "rect",
                  "from": { "data": "valid_group_date" },
                  "encode": {
                    "update": {
                      "x": { "scale": "dateX", "field": "collection_week" },
                      "y": { "scale": "percentY", "field": "y0" },
                      "y2": {"scale": "percentY", "field": "y1"},
                      "stroke": { "scale": "group_color", "field": "group" },
                      "on": [
                        {"trigger": "mouseover", "modify": {"signal": "hoverGroup", "value": "datum.group"}}
                      ],
                      "strokeWidth": { "value":20},
                      "strokeOpacity": [
                        {
                          "test": "(indata('hover_legend', 'group', datum.group) || hoverGroup === datum.group || other_hover === datum.group) || (!length(data('hover_legend')) && hoverGroup === null)",
                          "value": 1
                        },
                        {"value": 0.3}
                      ],
                      "zindex": { "value": 1 },
                      "tooltip": {
                                "signal": "{title: datum.group, 'Percent': format(datum.percent,'~p'), 'Date': datetime(datum.collection_week)}"
                            }
                    }
                  }
                },
                {
                  "type": "text",
                  "from": { "data": "label" },
                  "encode": {
                    "update": {
                      "x": {
                        "scale": "dateX",
                        "field": "collection_week",
                        "offset": 12
                      },
                      "y": { "scale": "percentY", "field": "percent" },
                      "text": { "field": "group" },
                      "fill": [
                        {
                          "test": "!indata('valid_groups', 'group', datum.group)",
                          "value": "#aaa"
                        },
                        { "scale": "group_color", "field": "group" }
                      ],
                      "fontSize": { "value": 10 },
                      "fontWeight": { "value": "500" },
                      "baseline": { "value": "middle" }
                    }
                  }
                }
              ]
            },
            {
              "type": "rule",
              "from": {"data": "annotation"},
              "encode": {
                "enter": {
                  "stroke": {"value": "#FF0000"}
                },
                "update": {
                  "x": {
                    "scale": "dateX",
                    "field": "start"
                  },
                  "y": {"value": -5},
                  "x2": { "signal": "width" },
                  "y2": {"value": -5},
                  "strokeWidth": {"value": 2},
                  "opacity": {"value": 1}
                },
                "hover": {
                  "opacity": {"value": 0.5}
                }
              }
            }
          ]
        }
      ]
    },
    {
      "type": "group",
      "encode": {
        "update": {
          "x": { "value": 900 },
          "y": { "value": 0 },
          "width": { "value": 100 },
          "height": { "signal": "height" }
        }
      }
    }
  ]
}